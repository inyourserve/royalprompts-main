<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
        }
        .form-label {
            font-weight: 500;
        }
        .btn-floating {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            text-align: center;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }
        .btn-floating i {
            line-height: 60px;
            font-size: 1.5rem;
        }
        .category-card {
            margin-bottom: 20px;
        }
        .subcategory-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .subcategory-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            margin-right: 10px;
        }

    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="#">Category Management</a>
    </div>
</nav>

<div class="container mt-4">
    <h1 class="text-center mb-4">Manage Categories and Subcategories</h1>

    <div class="card">
        <div class="card-body">
            <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pills-category-tab" data-bs-toggle="pill"
                            data-bs-target="#pills-category" type="button" role="tab">Create Category
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-subcategory-tab" data-bs-toggle="pill"
                            data-bs-target="#pills-subcategory" type="button" role="tab">Create Subcategory
                    </button>
                </li>
            </ul>
            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="pills-category" role="tabpanel">
                    <form id="category-form" class="needs-validation" novalidate>
                        <div class="mb-3">
                            <label for="category-name" class="form-label">Category Name</label>
                            <input type="text" class="form-control" id="category-name" name="name" required>
                            <div class="invalid-feedback">Please enter a category name.</div>
                        </div>
                        <div class="mb-3">
                            <label for="category-thumbnail" class="form-label">Thumbnail</label>
                            <input type="file" class="form-control" id="category-thumbnail" name="thumbnail">
                        </div>
                        <button type="submit" class="btn btn-primary">Create Category</button>
                    </form>
                </div>
                <div class="tab-pane fade" id="pills-subcategory" role="tabpanel">
                    <form id="subcategory-form" class="needs-validation" novalidate>
                        <div class="mb-3">
                            <label for="subcategory-category-id" class="form-label">Category</label>
                            <select class="form-select" id="subcategory-category-id" name="category_id" required>
                                <option value="">Select a category</option>
                            </select>
                            <div class="invalid-feedback">Please select a category.</div>
                        </div>
                        <div class="mb-3">
                            <label for="subcategory-name" class="form-label">Subcategory Name</label>
                            <input type="text" class="form-control" id="subcategory-name" name="name" required>
                            <div class="invalid-feedback">Please enter a subcategory name.</div>
                        </div>
                        <div class="mb-3">
                            <label for="subcategory-thumbnail" class="form-label">Thumbnail</label>
                            <input type="file" class="form-control" id="subcategory-thumbnail" name="thumbnail">
                        </div>
                        <button type="submit" class="btn btn-primary">Create Subcategory</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">
    <h2 class="text-center mb-4">Categories and Subcategories</h2>
    <div id="categoriesList" class="row">
        <!-- Categories and subcategories will be dynamically added here -->
    </div>
</div>

<button class="btn btn-primary btn-floating" data-bs-toggle="modal" data-bs-target="#categoryListModal">
    <i class="bi bi-list"></i>
</button>

<!-- Category List Modal -->
<div class="modal fade" id="categoryListModal" tabindex="-1" aria-labelledby="categoryListModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryListModalLabel">Category List</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul id="categoryList" class="list-group">
                    <!-- Categories will be dynamically added here -->
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCategoryModalLabel">Edit Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-category-form" class="needs-validation" novalidate>
                    <input type="hidden" id="edit-category-id" name="category_id">
                    <div class="mb-3">
                        <label for="edit-category-name" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="edit-category-name" name="name" required>
                        <div class="invalid-feedback">Please enter a category name.</div>
                    </div>
                    <div class="mb-3">
                        <label for="edit-category-thumbnail" class="form-label">New Thumbnail (optional)</label>
                        <input type="file" class="form-control" id="edit-category-thumbnail" name="thumbnail">
                    </div>
                    <button type="submit" class="btn btn-primary">Update Category</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Subcategory Modal -->
<div class="modal fade" id="editSubcategoryModal" tabindex="-1" aria-labelledby="editSubcategoryModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSubcategoryModalLabel">Edit Subcategory</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-subcategory-form" class="needs-validation" novalidate>
                    <input type="hidden" id="edit-subcategory-category-id" name="category_id">
                    <input type="hidden" id="edit-subcategory-id" name="subcategory_id">
                    <div class="mb-3">
                        <label for="edit-subcategory-name" class="form-label">Subcategory Name</label>
                        <input type="text" class="form-control" id="edit-subcategory-name" name="name" required>
                        <div class="invalid-feedback">Please enter a subcategory name.</div>
                    </div>
                    <div class="mb-3">
                        <label for="edit-subcategory-thumbnail" class="form-label">New Thumbnail (optional)</label>
                        <input type="file" class="form-control" id="edit-subcategory-thumbnail" name="thumbnail">
                    </div>
                    <button type="submit" class="btn btn-primary">Update Subcategory</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Fetch and populate categories
    async function fetchCategories() {
        try {
            const response = await fetch('/api/v1/categories');
            const data = await response.json();
            const categoriesList = document.getElementById('categoriesList');
            const dropdown = document.getElementById('subcategory-category-id');
            const categoryList = document.getElementById('categoryList');

            categoriesList.innerHTML = '';
            dropdown.innerHTML = '<option value="">Select a category</option>';
            categoryList.innerHTML = '';

            data.categories.forEach(category => {
                // Populate dropdown
                dropdown.innerHTML += `<option value="${category._id}">${category.name}</option>`;

                // Create category card
                const categoryCard = document.createElement('div');
                categoryCard.className = 'col-md-6 category-card';
                categoryCard.innerHTML = `
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title">${category.name}</h5>
                            <div>
                                <button class="btn btn-primary btn-sm me-2" onclick="openEditCategoryModal('${category._id}', '${category.name}')">Edit</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteCategory('${category._id}')">Delete</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <img src="https://workerlly-images.s3.ap-south-1.amazonaws.com/${category.thumbnail}" alt="${category.name}" class="img-fluid mb-3" style="max-height: 200px; width: auto;">
                            <h6>Subcategories:</h6>
                            <div class="subcategories-list">
                                ${category.sub_categories.map(sub => `
                                    <div class="subcategory-item">
                                        <img src="https://workerlly-images.s3.ap-south-1.amazonaws.com/${sub.thumbnail}" alt="${sub.name}">
                                        <span>${sub.name}</span>
                                        <button class="btn btn-primary btn-sm ms-2" onclick="openEditSubcategoryModal('${category._id}', '${sub.id}', '${sub.name}')">Edit</button>
                                        <button class="btn btn-danger btn-sm ms-2" onclick="deleteSubcategory('${category._id}', '${sub.id}')">Delete</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                categoriesList.appendChild(categoryCard);

                // Populate modal list
                categoryList.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${category.name}
                        <img src="https://workerlly-images.s3.ap-south-1.amazonaws.com/${category.thumbnail}" alt="${category.name}" style="width: 50px; height: 50px; object-fit: cover;">
                    </li>`;
            });
        } catch (error) {
            console.error('Error fetching categories:', error);
            showToast('Failed to load categories', 'danger');
        }
    }

    // Function to delete a category
    async function deleteCategory(categoryId) {
        if (confirm("Are you sure you want to delete this category?")) {
            try {
                const response = await fetch(`/api/v1/categories/${categoryId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (response.ok) {
                    showToast(result.message, 'success');
                    fetchCategories();
                } else {
                    showToast('Failed to delete category', 'danger');
                }
            } catch (error) {
                console.error('Error deleting category:', error);
                showToast('An error occurred while deleting category', 'danger');
            }
        }
    }

    // Function to delete a subcategory
    async function deleteSubcategory(categoryId, subcategoryId) {
        if (confirm("Are you sure you want to delete this subcategory?")) {
            try {
                const response = await fetch(`/api/v1/subcategories/${categoryId}/${subcategoryId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (response.ok) {
                    showToast(result.message, 'success');
                    fetchCategories();
                } else {
                    showToast('Failed to delete subcategory', 'danger');
                }
            } catch (error) {
                console.error('Error deleting subcategory:', error);
                showToast('An error occurred while deleting subcategory', 'danger');
            }
        }
    }

    // Function to open edit category modal
 function openEditCategoryModal(categoryId, categoryName) {
        document.getElementById('edit-category-id').value = categoryId;
        document.getElementById('edit-category-name').value = categoryName;
        new bootstrap.Modal(document.getElementById('editCategoryModal')).show();
    }

    // Function to open edit subcategory modal
    function openEditSubcategoryModal(categoryId, subcategoryId, subcategoryName) {
        document.getElementById('edit-subcategory-category-id').value = categoryId;
        document.getElementById('edit-subcategory-id').value = subcategoryId;
        document.getElementById('edit-subcategory-name').value = subcategoryName;
        new bootstrap.Modal(document.getElementById('editSubcategoryModal')).show();
    }

    // Initialize categories on page load
    document.addEventListener('DOMContentLoaded', fetchCategories);

    document.getElementById('category-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        try {
            const response = await fetch('/api/v1/categories', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (response.ok) {
                showToast(result.message, 'success');
                fetchCategories();
                event.target.reset();
            } else {
                showToast('Failed to submit category', 'danger');
            }
        } catch (error) {
            showToast('An error occurred', 'danger');
        }
    });

    document.getElementById('subcategory-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        try {
            const response = await fetch('/api/v1/subcategories', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (response.ok) {
                showToast(result.message, 'success');
                fetchCategories();
                event.target.reset();
            } else {
                showToast('Failed to submit subcategory', 'danger');
            }
        } catch (error) {
            showToast('An error occurred', 'danger');
        }
    });

    // Edit category form submission
    document.getElementById('edit-category-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const categoryId = formData.get('category_id');
        try {
            const response = await fetch(`/api/v1/categories/${categoryId}`, {
                method: 'PUT',
                body: formData
            });
            const result = await response.json();
            if (response.ok) {
                showToast(result.message, 'success');
                fetchCategories();
                bootstrap.Modal.getInstance(document.getElementById('editCategoryModal')).hide();
            } else {
                showToast('Failed to update category', 'danger');
            }
        } catch (error) {
            showToast('An error occurred', 'danger');
        }
    });

    // Edit subcategory form submission
    document.getElementById('edit-subcategory-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const categoryId = formData.get('category_id');
        const subcategoryId = formData.get('subcategory_id');
        try {
            const response = await fetch(`/api/v1/subcategories/${categoryId}/${subcategoryId}`, {
                method: 'PUT',
                body: formData
            });
            const result = await response.json();
            if (response.ok) {
                showToast(result.message, 'success');
                fetchCategories();
                bootstrap.Modal.getInstance(document.getElementById('editSubcategoryModal')).hide();
            } else {
                showToast('Failed to update subcategory', 'danger');
            }
        } catch (error) {
            showToast('An error occurred', 'danger');
        }
    });

    // Bootstrap form validation
    (() => {
        'use strict'
        const forms = document.querySelectorAll('.needs-validation')
        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
    })()

    function showToast(message, type) {
        const toastContainer = document.createElement('div');
        toastContainer.style.position = 'fixed';
        toastContainer.style.top = '20px';
        toastContainer.style.right = '20px';
        toastContainer.style.zIndex = '1050';

        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');

        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;

        toastContainer.appendChild(toast);
        document.body.appendChild(toastContainer);

        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();

        toast.addEventListener('hidden.bs.toast', function () {
            toastContainer.remove();
        });
    }

</script>
</body>
</html>