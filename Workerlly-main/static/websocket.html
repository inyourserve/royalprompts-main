<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Seeker Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .job-card {
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .job-card:hover {
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .job-card-basic {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
        }
        .job-info h3 {
            margin: 0;
            font-size: 18px;
        }
        .job-info p {
            margin: 5px 0 0;
            color: #666;
            font-size: 14px;
        }
        .job-rate {
            font-size: 20px;
            font-weight: bold;
        }
        .job-card-details {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
        }

    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Job Seeker Portal</a>
    </div>
</nav>

<div class="container mt-4">
    <h1 class="mb-4">Job Listings</h1>
    <div id="connectionStatus" class="alert alert-info" role="alert">
        Connecting to job updates...
    </div>
    <div id="jobList" class="row">
        <!-- Jobs will be dynamically inserted here -->
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const WS_URL = 'ws://139.59.59.53:8000/ws';
    let socket;

    function log(message) {
        console.log(`${new Date().toISOString()} - ${message}`);
    }

    function connectWebSocket() {
        const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiNjZiYjAzMjdiY2NhOTMxMzUxYzMxNDhlIiwibW9iaWxlIjoiOTE5NTIzMzUzMzY1Iiwicm9sZXMiOlsic2Vla2VyIiwicHJvdmlkZXIiXSwiZXhwIjoxNzI1MTM0NTg3fQ.rJ_Q7chUrSYtCmlx9_Eg1uRa5ipMImyV9bQ61zDazpE';

        log(`Attempting to connect to WebSocket: ${WS_URL}`);
        socket = new WebSocket(`${WS_URL}?token=${token}`);

        socket.onopen = () => {
            log('WebSocket connected');
            document.getElementById('connectionStatus').textContent = 'Connected to job updates';
            document.getElementById('connectionStatus').className = 'alert alert-success';
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            log(`Received message: ${JSON.stringify(data)}`);

            if (data.type === 'new_job') {
                addNewJob(data.data);
            } else if (data.type === 'job_details') {
                updateJobDetails(data.data);
            } else if (data.type === 'error') {
                log(`Error: ${data.message}`);
                alert(`Error: ${data.message}`);
            }
        };

        socket.onclose = (event) => {
            log(`WebSocket disconnected. Code: ${event.code}, Reason: ${event.reason}`);
            document.getElementById('connectionStatus').textContent = 'Disconnected. Attempting to reconnect...';
            document.getElementById('connectionStatus').className = 'alert alert-warning';
            setTimeout(connectWebSocket, 5000);
        };

        socket.onerror = (error) => {
            log(`WebSocket error: ${error}`);
            document.getElementById('connectionStatus').textContent = 'Error in connection. Attempting to reconnect...';
            document.getElementById('connectionStatus').className = 'alert alert-danger';
        };
    }

    function addNewJob(job) {
        log(`Adding new job: ${JSON.stringify(job)}`);
        const jobList = document.getElementById('jobList');
        const jobElement = document.createElement('div');
        jobElement.className = 'col-md-6 mb-3';
        jobElement.innerHTML = `
            <div class="job-card" data-job-id="${job.id}">
                <div class="job-card-basic">
                    <div class="job-info">
                        <h3>${job.sub_category}</h3>
                        <p>${job.location}</p>
                    </div>
                    <div class="job-rate">
                        ₹ ${job.hourly_rate}
                    </div>
                </div>
            </div>
        `;
        jobElement.querySelector('.job-card').addEventListener('click', toggleJobDetails);
        jobList.prepend(jobElement);
    }

    function toggleJobDetails(event) {
        const jobCard = event.currentTarget;
        const jobId = jobCard.getAttribute('data-job-id');

        log(`Requesting details for job ${jobId}`);
        socket.send(JSON.stringify({ type: 'get_job_details', job_id: jobId }));
    }

    function updateJobDetails(jobDetails) {
        log(`Updating job details: ${JSON.stringify(jobDetails)}`);
        const jobCard = document.querySelector(`.job-card[data-job-id="${jobDetails.id}"]`);
        if (jobCard) {
            // Remove any existing job details card for this job
            const existingDetailsCard = document.querySelector(`.job-card-details[data-job-id="${jobDetails.id}"]`);
            if (existingDetailsCard) {
                existingDetailsCard.remove();
            }

            // Create a new card for job details
            const detailsCard = document.createElement('div');
            detailsCard.className = 'col-md-6 mb-3 job-card-details';
            detailsCard.setAttribute('data-job-id', jobDetails.id);
            detailsCard.innerHTML = `
                <div class="job-card">
                    <div class="job-card-basic">
                        <div class="job-info">
                            <h3>Details for ${jobDetails.sub_category}</h3>
                        </div>
                    </div>
                    <div class="job-card-details">
                        <p><strong>Provider:</strong> ${jobDetails.provider_name}</p>
                        <p><strong>Rating:</strong> ${jobDetails.provider_rating} ★</p>
                        <p><strong>Description:</strong> ${jobDetails.description}</p>
                        <p><strong>Distance:</strong> ${jobDetails.distance} KM</p>
                        <p><strong>Hourly Rate:</strong> ₹${jobDetails.hourly_rate}</p>
                        <div class="bid-buttons">
                            <button class="btn btn-primary" onclick="applyForJob(${jobDetails.id}, ${jobDetails.hourly_rate})">Apply - ₹${jobDetails.hourly_rate}</button>
                            <button class="btn btn-secondary" onclick="applyForJob(${jobDetails.id}, ${jobDetails.hourly_rate + 50})">Bid ₹${jobDetails.hourly_rate + 50}</button>
                            <button class="btn btn-secondary" onclick="applyForJob(${jobDetails.id}, ${jobDetails.hourly_rate + 100})">Bid ₹${jobDetails.hourly_rate + 100}</button>
                            <button class="btn btn-secondary" onclick="applyForJob(${jobDetails.id}, ${jobDetails.hourly_rate + 150})">Bid ₹${jobDetails.hourly_rate + 150}</button>
                            <button class="btn btn-danger" onclick="skipJob(${jobDetails.id})">Skip</button>
                        </div>
                    </div>
                </div>
            `;

            // Insert the new details card right after the job card
            jobCard.parentNode.insertBefore(detailsCard, jobCard.nextSibling);
            log(`Job details card created for job ${jobDetails.id}`);
        } else {
            log(`Job card not found for job ID: ${jobDetails.id}`);
        }
    }

    function skipJob(jobId) {
        log(`Skipping job ${jobId}`);
        const jobCard = document.querySelector(`.job-card[data-job-id="${jobId}"]`);
        const detailsCard = document.querySelector(`.job-card-details[data-job-id="${jobId}"]`);
        if (jobCard) jobCard.remove();
        if (detailsCard) detailsCard.remove();
    }

    function applyForJob(jobId, rate) {
        log(`Applying for job ${jobId} with rate ₹${rate}`);
        alert(`Applied for job ${jobId} with rate ₹${rate}`);
        // You can implement the logic to apply for the job here, possibly sending a request to the server
    }

    // Initial connection
    connectWebSocket();


</script>
</body>
</html>